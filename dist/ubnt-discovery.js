/*
 * Node Ubiquiti Discovery Tool
 * Author: Giovanni Vella (johnvan7)
 * License: GPL-3.0
 * Version: 1.0.1
 */
(()=>{var e={721:(e,r,o)=>{const t=o(891),{Buffer:a}=o(254),n=o(555),s=t.createSocket("udp4"),d=a.from("01000000","hex"),i=[];s.on("error",(e=>{console.error(`server error:\n${e.stack}`),s.close()})),s.on("message",((e,r)=>{const o={ip:"",mac:"",firmware:"",firmwareVersion:"",name:"",modelShort:"",modelFull:"",essid:"",mode:"",uptime:""};if("010000"!=e.toString("hex",0,3))return void console.log("INVALID signature");o.ip=r.address;let t=4;for(;e.byteLength-t>0;){const r=e.toString("hex",t,t+1);t+=2;const n=e.readInt8(t);t+=1;const s=e.toString("hex",t,t+n);switch(r){case"01":o.mac=s.toUpperCase().match(/.{1,2}/g).join(":");break;case"03":o.firmware=a.from(s,"hex").toString(),o.firmwareVersion=o.firmware.match(/v(\d+\.\d+\.\d+)/g)[0].slice(1);break;case"0b":o.name=a.from(s,"hex").toString();break;case"0c":o.modelShort=a.from(s,"hex").toString();break;case"14":o.modelFull=a.from(s,"hex").toString();break;case"0d":o.essid=a.from(s,"hex").toString();break;case"0e":switch(e.readInt8(t)){case 0:o.mode="auto";break;case 1:o.mode="adhoc";break;case 2:o.mode="sta";break;case 3:o.mode="ap";break;case 4:o.mode="repeater";break;case 5:o.mode="secondary";break;case 6:o.mode="monitor"}break;case"0a":o.uptime=e.readInt32BE(t).toString()}t+=n}0==i.filter((e=>e.ip==o.ip)).length&&i.push(o)})),e.exports={getDevices:(e=1e3)=>new Promise(((r,o)=>{s.bind((()=>{s.setBroadcast(!0),i.length=0,s.send(d,0,4,10001,"255.255.255.255",(function(e,r){e&&o(e)})),setTimeout((()=>{s.close(),i.sort(n.sortByIp),r(i)}),e)}))}))}},555:e=>{e.exports={sortByIp:function(e,r){return Number(e.ip.split(".").map((e=>`000${e}`.slice(-3))).join(""))-Number(r.ip.split(".").map((e=>`000${e}`.slice(-3))).join(""))},formatTimestamp:function(e){return e?`${Math.floor(e/86400)}d ${Math.floor(e%86400/3600)}h ${Math.floor(e%3600/60)}m`:""}}},891:e=>{"use strict";e.exports=require("dgram")},254:e=>{"use strict";e.exports=require("node:buffer")}},r={};function o(t){var a=r[t];if(void 0!==a)return a.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,o),n.exports}(()=>{const e=o(721),{formatTimestamp:r}=o(555);e.getDevices().then((e=>{console.log("IP".padEnd(15),"MAC".padEnd(19),"NAME".padEnd(23),"UPTIME".padEnd(12),"MODE".padEnd(6),"MODEL".padEnd(22),"SSID".padEnd(20),"FIRMWARE".padEnd(10),"\n"),e.forEach((e=>{const o=r(e.uptime);console.log(e.ip.toString().padEnd(15),e.mac.padEnd(19),e.name.padEnd(23),o.padEnd(12),e.mode.toUpperCase().padEnd(6),e.modelFull?e.modelFull.padEnd(22):e.modelShort.padEnd(22),e.essid.padEnd(20),e.firmwareVersion.padEnd(10))})),console.log("\nTotal devices:",e.length)})).catch((e=>{console.warn(e)}))})()})();